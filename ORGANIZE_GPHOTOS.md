# Organize Google Photos Files

This workflow helps you organize already-uploaded files in Google Photos into albums that match the original FTP folder structure.

## Problem

After uploading all movies to Google Photos using the main transfer workflow, all files end up in the main library without any folder organization. This workflow solves that by:

1. Reading the FTP structure manifest (generated by the `Generate FTP Structure Tree` workflow)
2. Creating albums in Google Photos matching the FTP folder structure
3. Moving uploaded files into their corresponding albums

## Prerequisites

Before running this workflow, you must:

1. **Upload files to Google Photos** using the `FTP to Google Photos Transfer` workflow
2. **Generate FTP manifest** using the `Generate FTP Structure Tree` workflow

## How It Works

### 1. File Mapping

The script reads the FTP manifest and builds a map of which files belong in which folders:

- Original structure: `Blockbuster Movies/Avatar (2009)/Avatar.3D.2009.1080p.mkv`
- Album name: `Blockbuster Movies/Avatar (2009)`
- File to move: `Avatar.3D.2009.1080p.mkv`

### 2. ISO to MKV Mapping

Since .iso files were converted to .mkv during upload, the script automatically maps them:

- FTP manifest shows: `MONSTR_IN_PARIS_3D.iso`
- Looks for in Google Photos: `MONSTR_IN_PARIS_3D.mkv`

### 3. Media Key Retrieval

The script uses a two-tier approach to find media keys:

**Primary**: `upload_state.json` file (from the transfer workflow)
- Fast lookup using cached media keys
- Works for files uploaded with the latest workflow (v2.0+)

**Fallback**: gpmc local cache database (v2.0+ with improved search)
- Searches Google Photos library cache (`~/.cache/gpmc/library.db`)
- Automatically used when upload state is incomplete or missing
- Helpful for files uploaded before state v2.0 or with older workflows
- **Important**: Run `gpmc update-cache` first to ensure the cache is up-to-date
- **New**: Uses multiple search strategies:
  - Exact filename match (case-sensitive)
  - Case-insensitive matching (handles `Movie.mkv` vs `movie.MKV`)
  - Pattern matching (handles `/path/to/file.mkv` vs `file.mkv`)
- **New**: Validates cache schema and reports issues clearly

This two-tier approach with improved search ensures maximum compatibility and reduces skipped files during organization.

### 4. Album Creation and Organization

**New in v2.1**: Enhanced with partial album support and detailed diagnostics.

For each folder in the FTP structure:
- Creates an album with the folder path as the name
- Adds all files from that folder to the album
- **If some files are missing** (partial albums enabled, default):
  - Creates album with available files
  - Logs which files are missing with detailed diagnostics
  - Missing files can be added later by re-running the script
- **If too many files are missing** (below threshold):
  - Skips the album
  - Logs detailed report of missing files
  - Provides actionable recommendations

### 5. Enhanced Logging and Diagnostics (v2.1)

The script now provides comprehensive logging for better troubleshooting:

**Album-level statistics**:
```
üìä ALBUM CACHE SUMMARY:
   Total files in album: 5
   Found in upload state cache: 3
   Found via gpmc cache fallback: 1
   Missing from all caches: 1
   Cache hit rate: 80.0%
```

**Per-file diagnostics** when files are missing:
```
‚ö†Ô∏è Not found in any cache: filename.mkv
   üìã DIAGNOSIS: File not found in either cache source
      - upload_state.json: No entry for filename.mkv
      - gpmc cache: No match after trying all search strategies
   üîß POSSIBLE CAUSES:
      1. File has not been uploaded to Google Photos yet
      2. Filename mismatch (check for special characters, encoding issues)
      3. Cache is out of sync - run 'gpmc update-cache' to refresh
```

**Missing Files Report** at end of run:
- Lists all albums with missing files
- Shows which files are missing from each album
- Indicates whether album was created partially or skipped
- Provides recommended actions to resolve issues

## Usage

### Automatic Cache Update (New in v2.2)

**No preparation required!** The organize workflow now automatically updates the Google Photos cache before organizing files. This ensures that:
- All files present in Google Photos are detected, even if `upload_state.json` is missing or incomplete
- Files uploaded with older workflows (v1.0) are properly found and organized
- No manual cache updates are needed before running the workflow

The cache update happens automatically as the first step of the organize workflow and takes a few minutes depending on your library size.

**For local runs**: If running the script locally (not via GitHub Actions), you can manually update the cache before organizing:
```python
from gpmc import Client
client = Client(auth_data="your_auth_data")
client.update_cache(show_progress=True)
```

**New in v2.1**: The script provides comprehensive diagnostics and supports partial album creation, allowing organization to proceed even when some files are missing.

### Manual Run (Recommended)

1. Go to **Actions** ‚Üí **Organize Google Photos Files**
2. Click **Run workflow**
3. Choose run mode and options:
   - **Dry run: true** - Preview what will be done (no changes)
   - **Dry run: false** - Actually organize files
   - **Partial albums: true** (default) - Create albums even if some files are missing
   - **Partial albums: false** - Only create albums if all files are found
   - **Min files threshold: 1** (default) - Minimum files required to create an album
4. Monitor the logs - the cache will be updated automatically before organizing
5. Download results from artifacts

**What's New**:
- **v2.2**: Automatic cache update eliminates manual preparation steps
- **v2.1**: Partial album support and detailed diagnostics for missing files

### First Run - Dry Run

**Always do a dry run first** to verify the organization plan:

```yaml
dry_run: true
```

This will show you:
- Which albums will be created
- Which files will be moved to each album
- Any files that couldn't be found

### Second Run - Live Mode

Once you've verified the dry run output, run again with:

```yaml
dry_run: false
partial_albums: true  # Create albums even if some files are missing (recommended)
min_files_threshold: 1  # Minimum files to create an album
```

This will actually create albums and move files.

### Command Line Options (Local/Manual Runs)

When running the script locally, you can use these command line options:

```bash
# Basic dry run
python3 organize_gphotos.py --dry-run

# Disable partial albums (only create complete albums)
python3 organize_gphotos.py --no-partial-albums

# Set minimum files threshold
python3 organize_gphotos.py --min-files=5

# Combined options
python3 organize_gphotos.py --dry-run --min-files=3

# Live run with partial albums (default behavior)
python3 organize_gphotos.py
```

**Options**:
- `--dry-run`: Preview mode - show what would be done without making changes
- `--no-partial-albums`: Disable partial album creation (skip albums with any missing files)
- `--min-files=N`: Set minimum number of files required to create an album (default: 1)

**Partial Albums (New in v2.1)**:
- Enabled by default - albums are created even if some files are missing
- Missing files can be added later by re-running the script
- Provides detailed Missing Files Report showing what's missing and why
- Can be disabled with `--no-partial-albums` to only create complete albums

## Example Structure

Given this FTP structure:

```
Blockbuster Movies/
‚îú‚îÄ‚îÄ Avatar (2009)/
‚îÇ   ‚îú‚îÄ‚îÄ Avatar.3D.2009.iso (converted to .mkv)
‚îÇ   ‚îî‚îÄ‚îÄ Avatar.2009.3D.BluRay.mkv
‚îî‚îÄ‚îÄ Gravity (2013)/
    ‚îî‚îÄ‚îÄ Gravity.2013.3D.BluRay.mkv
```

The workflow will create:

- Album: `Avatar (2009)`
  - Contains: `Avatar.3D.2009.mkv`, `Avatar.2009.3D.BluRay.mkv`
- Album: `Gravity (2013)`
  - Contains: `Gravity.2013.3D.BluRay.mkv`

## Album Naming

Albums are named using the leaf folder name (the movie folder) from the FTP structure:

- `A Monster in Paris (2011)`
- `Avatar (2009)`
- `Toy Story (1995)`

This creates clean album names using just the movie folder name, without the full parent path.

## Limitations

### 1. Files Not in Upload State

If a file wasn't uploaded via the transfer workflow, or if the `upload_state.json` is incomplete, the file will be skipped with a warning.

**Solution**: Ensure all files are uploaded before organizing.

### 2. Google Photos Album Limits

Google Photos has limits on:
- Album name length (max ~500 characters)
- Number of items per album (max 20,000)

If a folder has more than 20,000 files, the `add_to_album` method will automatically create additional numbered albums (e.g., "Folder Name", "Folder Name 2", etc.).

### 3. Duplicate Filenames

If multiple folders contain files with the same name, they may conflict. The script uses media keys to ensure the correct file is moved.

## Troubleshooting

### "No media keys found for album"

**Cause**: Files in that folder weren't uploaded or media keys couldn't be found.

**Solution (v2.2+)**: 
The workflow now automatically updates the Google Photos cache before organizing, so this issue should be rare. If it still occurs:
1. Verify files were successfully uploaded to Google Photos (check the web interface)
2. Re-run the organize workflow - the automatic cache update will detect newly uploaded files
3. Check the logs for specific diagnostic messages about why files weren't found

**For older versions**: Manually update the cache or upgrade to v2.2+.

**New in v2.1**: The script provides detailed diagnostics for each missing file, showing:
- Which caches were checked (upload_state.json, gpmc cache)
- Why the file wasn't found in each cache
- Specific recommended actions based on the failure mode

**Note**: The script automatically falls back to searching the gpmc cache database when files are not found in `upload_state.json`. The improved search uses multiple strategies:
- Exact filename match (case-sensitive)
- Case-insensitive matching
- Pattern matching (handles full paths vs basenames)

This helps recover from migrated v1.0 state files, incomplete upload states, and filename case mismatches.

### "Not found in any cache: filename.mkv"

**Cause**: The file is truly not uploaded yet.

**Solution (v2.2+)**: 
1. Verify the file appears in Google Photos web interface
2. Re-run the organize workflow - the automatic cache update should detect it
3. If the file is still not found after automatic cache update, check for:
   - Filename mismatches (special characters, encoding issues)
   - Files that failed to upload (check transfer workflow logs)

**New in v2.1**: When a file is missing, the script shows detailed diagnostics:
```
‚ö†Ô∏è Not found in any cache: filename.mkv
   üìã DIAGNOSIS: File not found in either cache source
      - upload_state.json: No entry for filename.mkv
      - gpmc cache: No match after trying all search strategies
   üîß POSSIBLE CAUSES:
      1. File has not been uploaded to Google Photos yet
      2. Filename mismatch (check for special characters, encoding issues)
      3. Cache is out of sync - automatic update will fix this
```

### "Skipped X entries with None media_key"

**Cause**: Your upload state file was migrated from v1.0 format, which didn't store media keys.

**Solution (v2.2+)**: 
This is expected and **not a problem**. The workflow automatically updates the gpmc cache, which will find all these files. The organization should proceed successfully with the automatic cache fallback.

**What happens**:
1. Workflow detects old state format with None media_keys
2. Automatically updates gpmc cache before organizing
3. Falls back to gpmc cache for all files with None media_keys
4. Files are organized successfully using the cache

### "Failed to add files to album"

**Cause**: Google Photos API error or authentication issue.

**Solution**:
1. Verify `GP_AUTH_DATA` secret is still valid
2. Check logs for specific error messages
3. Try running again (may be temporary API issue)

### "Partial album: X/Y files missing"

**New in v2.1**: This is a normal informational message when partial albums are enabled (default).

**What it means**: The album will be created with the files that are available, and missing files can be added later.

**To change behavior**:
- Disable partial albums: Set `partial_albums: false` in workflow inputs or use `--no-partial-albums` flag
- Set minimum threshold: Set `min_files_threshold: N` in workflow inputs or use `--min-files=N` flag

### Missing Files Report

**New in v2.1**: At the end of each run, a detailed Missing Files Report is generated showing:
- Which albums have missing files
- How many files are missing from each album
- Specific filenames that couldn't be found
- Whether the album was created partially or skipped entirely
- Recommended actions to resolve the issues

Example:
```
üìã MISSING FILES REPORT
Albums with missing files: 2

Album: Blockbuster Movies/Avatar (2009)
  Status: PARTIAL - Some files added
  Total files: 5
  Found files: 3
  Missing files (2):
    - Avatar.Extras.mkv
    - Avatar.BehindTheScenes.mkv

Album: Blockbuster Movies/Gravity (2013)
  Status: SKIPPED - No files found
  Total files: 3
  Missing files (3):
    - Gravity.3D.mkv
    - Gravity.2D.mkv
    - Gravity.Extras.mkv

üîß RECOMMENDED ACTIONS
To resolve missing files:
  1. Run 'gpmc update-cache' to refresh the Google Photos cache
  2. Verify files were successfully uploaded (check upload_state.json)
  3. Re-run this organization script to pick up newly found files
  4. Check for filename mismatches (special characters, encoding)
```

## State Files

The workflow uses two key files:

### 1. `ftp_structure_manifest.json`

Generated by the `Generate FTP Structure Tree` workflow. Contains:
- Complete FTP folder structure
- File names and sizes
- Metadata about the server

### 2. `upload_state.json`

Generated by the `FTP to Google Photos Transfer` workflow. Contains:
- List of successfully uploaded files
- Media keys for each file
- Upload timestamps

## Workflow Outputs

After running, check the artifacts for:

1. **organization-logs** - Detailed logs of the organization process
2. **GitHub Actions summary** - Quick overview of results

## Best Practices

### 1. Always Dry Run First

Never skip the dry run. It helps you:
- Verify the organization plan
- Catch issues before making changes
- Estimate how long the process will take

### 2. Review the Logs

After a dry run, review the logs to ensure:
- All expected albums will be created
- Files are mapped to the correct albums
- No unexpected skips or errors

### 3. Run in Batches

If you have many files, consider organizing in batches:
1. Modify the script to process only certain folders
2. Run for a subset of albums
3. Verify results
4. Continue with more batches

### 4. Backup State Files

Before running, download:
- `ftp_structure_manifest.json`
- `upload_state.json`

This lets you re-run if something goes wrong.

## Related Workflows

- **Generate FTP Structure Tree** - Creates the manifest used by this workflow
- **FTP to Google Photos Transfer** - Uploads files and creates the upload state

## Technical Details

### Media Key Resolution

The script resolves media keys in this order:

1. **Upload state cache** - Fast lookup from `upload_state.json`
2. **Skip if not found** - Warns and skips the file

This ensures only uploaded files are organized.

### ISO to MKV Mapping

The `map_iso_to_mkv()` function converts:
- `Movie.iso` ‚Üí `Movie.mkv`

This handles the automatic conversion that happened during upload.

### Album Path Construction

Album names are constructed from the folder path:
- Skip the root folder (`root/`)
- Use the full path after that
- Example: `root/Blockbuster Movies/Avatar (2009)` ‚Üí `Blockbuster Movies/Avatar (2009)`

## Example Run

```bash
# 1. Generate FTP manifest (if not already done)
# Run: Generate FTP Structure Tree workflow

# 2. Upload files (if not already done)
# Run: FTP to Google Photos Transfer workflow

# 3. Download artifacts
# - ftp_structure_manifest.json
# - upload_state.json

# 4. Organize files (dry run)
# Run: Organize Google Photos Files workflow with dry_run=true

# 5. Review logs

# 6. Organize files (live)
# Run: Organize Google Photos Files workflow with dry_run=false

# 7. Verify in Google Photos
# Check that albums were created and files were moved
```

## License

MIT License
