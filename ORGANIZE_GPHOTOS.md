# Organize Google Photos Files

This workflow helps you organize already-uploaded files in Google Photos into albums that match the original FTP folder structure.

## Problem

After uploading all movies to Google Photos using the main transfer workflow, all files end up in the main library without any folder organization. This workflow solves that by:

1. Reading the FTP structure manifest (generated by the `Generate FTP Structure Tree` workflow)
2. Creating albums in Google Photos matching the FTP folder structure
3. Moving uploaded files into their corresponding albums

## Prerequisites

Before running this workflow, you must:

1. **Upload files to Google Photos** using the `FTP to Google Photos Transfer` workflow
2. **Generate FTP manifest** using the `Generate FTP Structure Tree` workflow

## How It Works

### 1. File Mapping

The script reads the FTP manifest and builds a map of which files belong in which folders:

- Original structure: `Blockbuster Movies/Avatar (2009)/Avatar.3D.2009.1080p.mkv`
- Album name: `Blockbuster Movies/Avatar (2009)`
- File to move: `Avatar.3D.2009.1080p.mkv`

### 2. ISO to MKV Mapping

Since .iso files were converted to .mkv during upload, the script automatically maps them:

- FTP manifest shows: `MONSTR_IN_PARIS_3D.iso`
- Looks for in Google Photos: `MONSTR_IN_PARIS_3D.mkv`

### 3. Media Key Retrieval

The script uses a two-tier approach to find media keys:

**Primary**: `upload_state.json` file (from the transfer workflow)
- Fast lookup using cached media keys
- Works for files uploaded with the latest workflow (v2.0+)

**Fallback**: gpmc local cache database (v2.0+ with improved search)
- Searches Google Photos library cache (`~/.cache/gpmc/library.db`)
- Automatically used when upload state is incomplete or missing
- Helpful for files uploaded before state v2.0 or with older workflows
- **Important**: Run `gpmc update-cache` first to ensure the cache is up-to-date
- **New**: Uses multiple search strategies:
  - Exact filename match (case-sensitive)
  - Case-insensitive matching (handles `Movie.mkv` vs `movie.MKV`)
  - Pattern matching (handles `/path/to/file.mkv` vs `file.mkv`)
- **New**: Validates cache schema and reports issues clearly

This two-tier approach with improved search ensures maximum compatibility and reduces skipped files during organization.

### 4. Album Creation and Organization

For each folder in the FTP structure:
- Creates an album with the folder path as the name
- Adds all files from that folder to the album

## Usage

### Preparation (Recommended)

Before running the organize workflow, especially if you're getting "No media keys found" warnings:

**Update gpmc cache** (optional but highly recommended):
```bash
# This updates the local cache with all your Google Photos media
gpmc update-cache
```

This command:
- Downloads metadata for all media in your Google Photos library
- Stores it in `~/.cache/gpmc/library.db`
- Enables the organize script to find media keys even if `upload_state.json` is incomplete
- Takes a few minutes depending on your library size

### Manual Run (Recommended)

1. Go to **Actions** → **Organize Google Photos Files**
2. Click **Run workflow**
3. Choose run mode:
   - **Dry run: true** - Preview what will be done (no changes)
   - **Dry run: false** - Actually organize files
4. Monitor the logs
5. Download results from artifacts

### First Run - Dry Run

**Always do a dry run first** to verify the organization plan:

```yaml
dry_run: true
```

This will show you:
- Which albums will be created
- Which files will be moved to each album
- Any files that couldn't be found

### Second Run - Live Mode

Once you've verified the dry run output, run again with:

```yaml
dry_run: false
```

This will actually create albums and move files.

## Example Structure

Given this FTP structure:

```
Blockbuster Movies/
├── Avatar (2009)/
│   ├── Avatar.3D.2009.iso (converted to .mkv)
│   └── Avatar.2009.3D.BluRay.mkv
└── Gravity (2013)/
    └── Gravity.2013.3D.BluRay.mkv
```

The workflow will create:

- Album: `Blockbuster Movies/Avatar (2009)`
  - Contains: `Avatar.3D.2009.mkv`, `Avatar.2009.3D.BluRay.mkv`
- Album: `Blockbuster Movies/Gravity (2013)`
  - Contains: `Gravity.2013.3D.BluRay.mkv`

## Album Naming

Albums are named using the full folder path from the FTP structure:

- `Blockbuster Movies/A Monster in Paris (2011)`
- `Blockbuster Movies/Avatar (2009)`
- `Blockbuster Movies/Toy Story (1995)`

This preserves the complete folder hierarchy in a flat album structure.

## Limitations

### 1. Files Not in Upload State

If a file wasn't uploaded via the transfer workflow, or if the `upload_state.json` is incomplete, the file will be skipped with a warning.

**Solution**: Ensure all files are uploaded before organizing.

### 2. Google Photos Album Limits

Google Photos has limits on:
- Album name length (max ~500 characters)
- Number of items per album (max 20,000)

If a folder has more than 20,000 files, the `add_to_album` method will automatically create additional numbered albums (e.g., "Folder Name", "Folder Name 2", etc.).

### 3. Duplicate Filenames

If multiple folders contain files with the same name, they may conflict. The script uses media keys to ensure the correct file is moved.

## Troubleshooting

### "No media keys found for album"

**Cause**: Files in that folder weren't uploaded or media keys couldn't be found.

**Solution**: 
1. Ensure files were uploaded using the transfer workflow
2. Run `gpmc update-cache` to update the local Google Photos cache
3. Re-run the organize workflow (it will use the gpmc cache as fallback)
4. If problems persist, verify `upload_state.json` contains the files with valid media keys

**Note**: The script now automatically falls back to searching the gpmc cache database when files are not found in `upload_state.json`. The improved search uses multiple strategies:
- Exact filename match (case-sensitive)
- Case-insensitive matching
- Pattern matching (handles full paths vs basenames)

This helps recover from migrated v1.0 state files, incomplete upload states, and filename case mismatches.

### "Not found in any cache: filename.mkv"

**Cause**: The file is truly not uploaded yet, or both caches are missing/incomplete.

**Solution**: 
1. Upload the file using the transfer workflow first
2. Run `gpmc update-cache` to sync your local cache with Google Photos
3. Verify the file appears in Google Photos web interface
4. Re-run the organize workflow

**Improved Diagnostics**: The script now provides more specific error messages:
- If gpmc cache database is missing, it will suggest running `gpmc update-cache`
- If the cache exists but is empty, it will warn you
- If the schema is incorrect, it will show available columns

### "Skipped X entries with None media_key"

**Cause**: Your upload state file was migrated from v1.0 format, which didn't store media keys.

**Solution**: 
This is expected and **not a problem**. The script will automatically use the gpmc cache fallback to find these files. If you want to update your state file:
1. Run `gpmc update-cache` to ensure the cache is up-to-date
2. The organize workflow will find the media keys via fallback
3. Alternatively, re-run uploads with the latest upload workflow (v2.0) to generate proper media keys

### "Failed to add files to album"

**Cause**: Google Photos API error or authentication issue.

**Solution**:
1. Verify `GP_AUTH_DATA` secret is still valid
2. Check logs for specific error messages
3. Try running again (may be temporary API issue)

## State Files

The workflow uses two key files:

### 1. `ftp_structure_manifest.json`

Generated by the `Generate FTP Structure Tree` workflow. Contains:
- Complete FTP folder structure
- File names and sizes
- Metadata about the server

### 2. `upload_state.json`

Generated by the `FTP to Google Photos Transfer` workflow. Contains:
- List of successfully uploaded files
- Media keys for each file
- Upload timestamps

## Workflow Outputs

After running, check the artifacts for:

1. **organization-logs** - Detailed logs of the organization process
2. **GitHub Actions summary** - Quick overview of results

## Best Practices

### 1. Always Dry Run First

Never skip the dry run. It helps you:
- Verify the organization plan
- Catch issues before making changes
- Estimate how long the process will take

### 2. Review the Logs

After a dry run, review the logs to ensure:
- All expected albums will be created
- Files are mapped to the correct albums
- No unexpected skips or errors

### 3. Run in Batches

If you have many files, consider organizing in batches:
1. Modify the script to process only certain folders
2. Run for a subset of albums
3. Verify results
4. Continue with more batches

### 4. Backup State Files

Before running, download:
- `ftp_structure_manifest.json`
- `upload_state.json`

This lets you re-run if something goes wrong.

## Related Workflows

- **Generate FTP Structure Tree** - Creates the manifest used by this workflow
- **FTP to Google Photos Transfer** - Uploads files and creates the upload state

## Technical Details

### Media Key Resolution

The script resolves media keys in this order:

1. **Upload state cache** - Fast lookup from `upload_state.json`
2. **Skip if not found** - Warns and skips the file

This ensures only uploaded files are organized.

### ISO to MKV Mapping

The `map_iso_to_mkv()` function converts:
- `Movie.iso` → `Movie.mkv`

This handles the automatic conversion that happened during upload.

### Album Path Construction

Album names are constructed from the folder path:
- Skip the root folder (`root/`)
- Use the full path after that
- Example: `root/Blockbuster Movies/Avatar (2009)` → `Blockbuster Movies/Avatar (2009)`

## Example Run

```bash
# 1. Generate FTP manifest (if not already done)
# Run: Generate FTP Structure Tree workflow

# 2. Upload files (if not already done)
# Run: FTP to Google Photos Transfer workflow

# 3. Download artifacts
# - ftp_structure_manifest.json
# - upload_state.json

# 4. Organize files (dry run)
# Run: Organize Google Photos Files workflow with dry_run=true

# 5. Review logs

# 6. Organize files (live)
# Run: Organize Google Photos Files workflow with dry_run=false

# 7. Verify in Google Photos
# Check that albums were created and files were moved
```

## License

MIT License
