name: Google Photos WebDAV Server

on:
  workflow_dispatch:

jobs:
  webdav-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Update GPMC cache
        env:
          GP_AUTH_DATA: ${{ secrets.GP_AUTH_DATA }}
        run: |
          # Create update script
          cat <<EOF > update_cache.py
          from gpmc import Client
          import os
          import sqlite3
          
          print('Initializing client...')
          client = Client(auth_data=os.environ['GP_AUTH_DATA'])
          print(f'Cache path: {client.db_path}')
          
          print('Starting cache update (this may take a while)...')
          # update_cache handles pagination and large libraries automatically
          client.update_cache(show_progress=True)
          print('Cache update completed.')
          
          # Verify
          if os.path.exists(client.db_path):
              with sqlite3.connect(client.db_path) as conn:
                  cursor = conn.cursor()
                  cursor.execute("SELECT COUNT(*) FROM remote_media")
                  count = cursor.fetchone()[0]
                  print(f'Total items in cache: {count}')
          else:
        run: |
          echo "Starting Cloudflare Tunnel..."
          cloudflared tunnel --no-autoupdate run --token $(cat ~/.cloudflared/tunnel_token) > tunnel.log 2>&1 &
          sleep 10
          
          echo "=========================================="
          echo "ðŸŽ‰ WebDAV Server is now accessible!"
          echo "=========================================="
          echo ""
          echo "Check your Cloudflare Tunnel dashboard for the public URL"
          echo "Or check the public hostname you configured"
          echo ""
          echo "Connection details:"
          echo "  Protocol: WebDAV"
          echo "  Username: user"
          echo "  Password: 12345"
          echo ""
          echo "For VR headsets (Quest, Pico, etc.):"
          echo "  1. Open your video player app"
          echo "  2. Add network storage / WebDAV"
          echo "  3. Enter the Cloudflare URL"
          echo "  4. Use credentials above"
          echo "=========================================="
          
          # Keep workflow running
          echo "Server will run for up to 6 hours or until manually cancelled"
          tail -f webdav.log tunnel.log
