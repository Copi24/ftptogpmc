name: Generate FTP Structure Tree

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st at midnight UTC

env:
  PYTHONUNBUFFERED: 1

jobs:
  generate-tree:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version
      
      - name: Configure rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          echo "âœ… Rclone config created"
      
      - name: Test rclone connection
        run: |
          echo "ğŸ” Testing connection to FTP server..."
          rclone lsd Challenger: --max-depth 1 || echo "âš ï¸  Warning: Could not list root directory"
      
      - name: Generate FTP structure tree
        run: |
          echo "ğŸ“¡ Starting FTP tree generation..."
          python3 generate_ftp_tree.py
        continue-on-error: false
      
      - name: Display results
        if: always()
        run: |
          echo "ğŸ“Š Generated files:"
          ls -lh ftp_structure_*.* || echo "No output files found"
          
          if [ -f "ftp_structure_manifest.json" ]; then
            echo ""
            echo "ğŸ“„ Manifest statistics:"
            python3 << 'PYEOF'
          import json
          with open('ftp_structure_manifest.json') as f:
              data = json.load(f)
              print(f"Total files: {data['statistics']['total_files']}")
              print(f"Total size: {data['statistics']['total_size_gb']} GB")
          PYEOF
          fi
          
          if [ -f "ftp_structure_tree.txt" ]; then
            echo ""
            echo "ğŸ“ Tree preview (first 50 lines):"
            head -50 ftp_structure_tree.txt
          fi
      
      - name: Upload manifest as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ftp-structure-manifest
          path: |
            ftp_structure_manifest.json
            ftp_structure_tree.txt
          retention-days: 365  # Keep for 1 year
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tree-generation-logs
          path: ftp_tree_generation.log
          retention-days: 30
      
      - name: Create summary
        if: always()
        run: |
          echo "# FTP Structure Tree Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "ftp_structure_manifest.json" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Statistics" >> $GITHUB_STEP_SUMMARY
            
            python3 << 'PYEOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open('ftp_structure_manifest.json') as f:
              data = json.load(f)
              stats = data['statistics']
              meta = data['metadata']
              print(f"- **Total Files:** {stats['total_files']:,}")
              print(f"- **Total Size:** {stats['total_size_gb']:,.2f} GB")
              print(f"- **Server:** {meta['server']} ({meta['server_host']})")
              print(f"- **Generated:** {meta['generated_at']}")
          PYEOF
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Output Files" >> $GITHUB_STEP_SUMMARY
            echo "- \`ftp_structure_manifest.json\` - Complete structure with metadata (JSON format)" >> $GITHUB_STEP_SUMMARY
            echo "- \`ftp_structure_tree.txt\` - Human-readable tree visualization" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¥ Download from the **Artifacts** section above" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
